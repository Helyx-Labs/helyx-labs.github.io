<!DOCTYPE html>
<html>
<head>
  <title>Spectra Editor</title>
  <link rel="stylesheet" href="../styles.css">
</head>
<body>
  <h2>Loading editor...</h2>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm"

const supabase = createClient(
  "https://fhnqoxviinkormcgikhy.supabase.co",
  "sb_publishable__UR8-57E5ItsS87rnBhXIg___AH8ECy",
  { auth: { detectSessionInUrl: true } }
)

async function init() {
  const { data: { session } } = await supabase.auth.getSession()
  if (!session) return location.href = "/dev/"

  // Fetch all spectra content
  const { data } = await supabase
    .from("content")
    .select("*")
    .eq("page", "spectra")

  // Map content by section
  const map = {}
  data.forEach(row => map[row.section] = row)

  // Render inputs dynamically
  const editorHTML = Object.keys(map).map(section => {
    return `
      <label>${section}</label><br>
      <textarea id="${section}" rows="2">${map[section].content}</textarea><br><br>
    `
  }).join("")

  document.body.innerHTML = `
    <h2>Spectra Webpage Editor</h2>
    <p>Logged in as: ${session.user.email}</p>
    ${editorHTML}
    <button id="save">Save All</button>
    <button id="logout">Logout</button>
    <p id="status"></p>
  `

  document.getElementById("logout").onclick = async () => {
    await supabase.auth.signOut()
    location.href = "/dev/"
  }

  document.getElementById("save").onclick = async () => {
    document.getElementById("status").innerText = "Saving..."
    for (let section of Object.keys(map)) {
      const content = document.getElementById(section).value
      await supabase.from("content").update({ content }).eq("id", map[section].id)
    }
    document.getElementById("status").innerText = "All changes saved!"
  }
}

init()
</script>

</body>
</html>
